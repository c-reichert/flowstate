#!/usr/bin/env bash
# SessionStart hook for flowstate plugin
# Injects core workflow context into every session via additionalContext

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
PLUGIN_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Escape string for JSON embedding
escape_for_json() {
    local s="$1"
    s="${s//\\/\\\\}"
    s="${s//\"/\\\"}"
    s="${s//$'\n'/\\n}"
    s="${s//$'\r'/\\r}"
    s="${s//$'\t'/\\t}"
    printf '%s' "$s"
}

# Build the context that gets injected into every session
context="Flowstate plugin loaded.

## Workflow
brainstorm → write-plan → [deepen-plan] → work → review → compound

## Commands
  /workflow:brainstorm    - Guided design session with structured dialogue
  /workflow:write-plan    - Create TDD implementation plan with research agents
  /workflow:deepen-plan   - Enhance plan with parallel research per section
  /workflow:work          - Execute plan with TDD, worktrees, subagent dispatch
  /workflow:review        - 5-agent parallel code review with prioritized findings
  /workflow:deep-review   - Extended 14+ agent review with conditional reviewers
  /workflow:compound      - Capture learnings to docs/solutions/ for future sessions
  /workflow:debug         - 6-step systematic debugging with 3-strike escalation
  /workflow:setup         - Show workflow pipeline, commands, and getting-started guide
  /workflow:remind        - Re-inject core rules when Claude drifts from the workflow

Start with /workflow:brainstorm for new features, or /workflow:debug for bugs.

NOTE: /workflow:write-plan is NOT Claude Code's built-in plan mode. Never call EnterPlanMode/ExitPlanMode during flowstate workflows.

## Core Rules (Always Active)

### TDD Iron Law
NO PRODUCTION CODE WITHOUT A FAILING TEST FIRST.
Cycle: RED (write failing test) → VERIFY RED (run it, see it fail) → GREEN (minimal code to pass) → VERIFY GREEN (run it, see it pass) → REFACTOR.
If you didn't watch the test fail, you don't know if it tests the right thing.
Exceptions ONLY with explicit user permission: throwaway prototypes, generated code, config files.

### Verification Before Completion
NO COMPLETION CLAIMS WITHOUT FRESH VERIFICATION EVIDENCE.
Before claiming any status: (1) Identify verification command, (2) Run it fresh, (3) Read complete output, (4) Only then state results.
If you haven't run the command in THIS message, you cannot claim it passes.

### Brainstorm Before Build
Do NOT implement, write code, scaffold, or create files until the user's idea has been explored through brainstorming and a design exists. Every project goes through the process — 'too simple' is rationalization.

### Subagent Distrust
Do not trust implementer reports. Read actual code. The implementer may have finished suspiciously quickly. Spec reviewers must independently verify.

### Knowledge Compounding
After solving non-trivial problems, capture learnings in docs/solutions/ via /workflow:compound. Check docs/solutions/ and critical-patterns.md before starting work — past solutions prevent repeated mistakes."

escaped_context=$(escape_for_json "$context")

cat <<EOF
{
  "additional_context": "${escaped_context}",
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "${escaped_context}"
  }
}
EOF

exit 0
